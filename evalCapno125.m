% evalCapno.m
% Data: CapnoBase IEEE TBME Respiratory Rate Benchmark
% https://dataverse.scholarsportal.info/dataset.xhtml?persistentId=doi:10.5683/SP2/NLB8IT

close all; clear; clc

data = load('capno_data_125.mat'); 
data = data.data;
fs = 125;                        % sampling frequency (PPG and ECG signals)

M = length(data);
breathREF = zeros(M,8);
MAEs = zeros(M,1);
breathVAL = breathREF; 
ERR = breathREF;
absERR = breathREF;
select = ones(length(data),8);   % matrix 42 x 8
ERR1D = []; 
tic;
for i = 1 : 42                   % 42 signals
    
    PPG = data(i).sig.PPG; 
    ECG = data(i).sig.ECG; 
  
    for j = 1:8                  % 8 minutes
        breathREF(i,j) = GETbreathREF(i,j);
        if breathREF(i,j) == 0
            select(i,j) = 0;     
        end
        from = (j-1)*60*fs + 1;  % first vector index
        to = from + 60*fs - 1;   % the last index of the vector 
        
        % --- enter your function here ------------------------------------
        breathVAL(i,j) = RRestimate(fs, PPG(from:to), ECG(from:to));
        % --- breathVAL [breaths per minute] ------------------------------
        
        ERR(i,j) = (breathREF(i,j) - breathVAL(i,j)); 
        if select(i,j)~=0                             
            ERR1D = [ERR1D ERR(i,j)]; % vector of RR errors in minute sections
        end                                           
    
    end % j-th minute (8)
    
    ERR(i,:) = (breathREF(i,:) - breathVAL(i,:)).*select(i,:);
    absERR(i,:) = abs(breathREF(i,:) - breathVAL(i,:)).*select(i,:); 
    denom = sum(select(i,:));
    MAEs(i) = sum(absERR(i,:))/denom;
    
end % i-th signal (42)
toc;

figure, boxplot(abs(ERR1D)), 
title('absERROR: median (25-75th percentiles) [bpm]')
aver = sum(ERR1D)/length(ERR1D);
figure('position',[500 400 800 400]), boxplot(ERR'), 
line([1 M],[aver aver],'color','r','linestyle','--')
title('boxplots of RR estimations'),
xlabel('# of signal'); ylabel('error [bpm]')
legend(['Average (' num2str(round(aver,2)) ')'])

MAE = sum(abs(ERR1D))/length(ERR1D);

figure('position',[500 400 800 400]);
bar(MAEs); % subplot(211), bar(MAEs); axis([1 M 0 7]);
line([1 M],[MAE MAE],'color','r','linestyle','-')
title('CapnoBase Benchmark: MAEs â€“ Mean Absolute Errors')
xlabel('# of signal'); ylabel('MAE [bpm]')
legend('MAE',['Average (' num2str(round(MAE,2)) ')'])
disp(median(reshape(absERR,[],1)))
% subplot(212), boxplot(ERR'), axis([1 M -10 10]);

% --- respiratory rate reference values [breaths per minute] --------------
function breathREF = GETbreathREF(i,j)
A = [18.1134012841148,17.4000392461011,18.3214125876444,21.0527467747165,19.7476746201398,19.3913629313181,19.4284129909527,19.6990556789512
    28.6397812713602,28.9389815525624,28.8577200666214,28.6630744849445,28.8462279293740,28.9622632350514,28.6284523940520,28.9272847015070
    10.0027793218455,10.0027793218455,10.0083472454090,10.0139275766017,10.0027793218455,10.0083472454090,10.0083410571069,10.0055586436909
    38.5027178389063,37.1326314355993,35.5736782902137,34.9515880915754,34.8507680888869,33.8984253085544,31.4962799669330,30.2777369082246
    23.1139861258370,23.9047619047619,21.8978426273859,22.0588235294118,21.1394285789158,21.0282956681001,20.6541059367224,21.4926062583048
    12.4129371863866,12.2158140974446,11.8150029814324,11.4999742853154,11.8831571267563,11.8278511441879,11.8780763081168,11.5533162639993
    9.18602641070492,9.47619435635546,11.1596049513684,11.2236969207199,10.5171342541701,11.9168045835145,13.1195404973377,14.1524822607393
    25.7144956285357,33.9013109358152,29.1497975708502,31.2508477334997,26.8556546128418,29.1852883958147,31.3459517733594,33.7424202096120
    0,0,5.61550039774090,0,0,11.1533440890702,0,9.05395090908264
    9.85626301837767,12.2473666691820,12.0160695545222,14.5605339353192,13.9157844909200,6.97295711776348,12.1092026954580,14.2522192687697
    24.7448979591837,22.6917319043033,23.4841753730200,23.2936300265852,22.7427279780091,23.9521064113097,25.9185848340721,25.4427253983729
    18.0184693820292,17.6690957758937,19.1139468160617,18.9028922566572,18.1643775355589,18.4382495703250,23.3236176078496,21.9783168741949
    18.0090090090090,17.9911168298711,18.0000720002880,18.0180360721443,18.0270450811533,18.0451173158755,18.0270812437312,18.0451173158755
    11.0091743119266,11.0024449877751,11.0058096498508,10.9957279883930,11.0091753415047,11.0159129041745,10.9974098051139,10.9974036474358
    10.0588083196035,10.0083472454090,10.0847457627119,9.92880613362541,9.99445061043285,10.0055710099843,9.98622335160371,9.97787610619469
    40.9329961681069,38.2980457131992,39.6703969225389,41.3795290238025,41.0963724006896,40.7480859699290,41.9825215624516,41.9092535371605
    9.00562978582483,9,9.00788316561284,9.00901408672980,9.00788542153065,9.00112528132033,9.01014783262340,9.00450450450451
    8.99775562106728,8.99438988273773,9.00225562894229,9.00000225000056,9.00901803607215,9.00788203765437,9.00788203765437,9.00900957319993
    11.0193002652513,10.9991090785124,10.9856668206267,11.0650280834392,11.0278158596286,11.0125461838866,10.9873363482667,11.0142331532293
    14.9536741489674,14.3856838732795,14.5279302096525,14.3255640726482,14.3178227014408,14.3954597606321,14.2526749626505,14.1899903796675
    18.6579652390574,17.6474828787697,18.0408461754049,18.5862785862786,18.2279649284725,18.0997716927296,17.4556626169529,16.9576779155023
    11.8468036889641,13.2597332669126,11.4323955388607,11.5980585208739,11.5477385755793,12.1049584833300,12.5108676751869,13.8276546010449
    10.7910317623736,9.65277280503702,9.41919354419132,10.3094152538622,10.0987559818251,9.53156720017048,10.0488722542666,10.0419355461176
    14.0077905844392,14.0132368449762,14.0186915887850,14.0023358406303,14.0077821011673,14.0132368449762,14.0132368449762,14.0077821011673
    14.9968763015410,15.0093815153033,15,15,15.0062552126772,15.0031263026261,15.0062552126772,15.0062552126772
    11.0209727816818,10.9940451486848,11.0024490985412,11.0142269672488,11.0058127357542,10.9940471993634,11.0024460154663,11.0007703620702
    10.0055617352614,10.0000030864207,9.99722993227832,10,10.0027854998366,10.0027793218455,10.0055617352614,10.0055617352614
    10,10.0000030864207,10.0055617352614,10.0027793218455,10.0111234705228,10,10.0027793218455,10.0027793218455
    11.0058086212168,11.0024490985412,11.0176101929613,11.0192847789735,11.0209769132492,10.9990926504688,11.0159118727050,11.0125430923158
    8.98652077964685,8.98539998654377,8.98315672124680,8.98315672124680,8.97979601893470,8.98315672124680,8.98091569417912,8.98091569417912
    11.9800346045592,11.9800346045592,11.9800346045592,11.9800346045592,11.9740565427177,11.9760479041916,11.9720665052873,11.9800346045592
    6.99708692707526,6.99029231637927,6.99232792843203,6.99164912757146,6.99029231637927,6.99164912757146,6.99164912757146,6.99097322664892
    9.98613114287878,9.98890122086571,9.99445061043285,9.99167437500809,9.98890122086571,9.98060019492039,9.98059405794481,9.98061246889417
    17.3829432841723,17.5013187673354,18.1824860417279,17.9193673068918,17.6643938518433,18.2186981375622,18.2002022244692,18.6576946135449
    9.99445061043285,9.97509987076993,9.98613729007413,9.99722376457524,10.0056081090476,9.99444752915047,10.0000030864207,9.98890122086571
    9.99445061043285,9.98338870431894,10,10,10,10,10.0111358574610,10
    10,10,10,10,10,10,10,10
    13.5823473042846,14.0845415360502,15.1517835443298,15.3814137143546,15.5072158819541,15.3321976149915,15.5105817080723,15.6965403962632
    13.1342353836110,13.6519262141373,14.2405152422709,14.6550121255087,15.4805425346018,14.9504239471685,13.6703801221028,14.9858250624539
    27.1705696591888,26.6670324695812,28.5489324022459,29.7032938306030,19.9947929262767,16.1137953414581,10.4136569422497,9.93378693647323
    10.0000123456943,10,9.99722376457524,9.99445061043285,10.0055617352614,10.0055617352614,10.0111265672545,10.0250634340627
    13.6525858974477,16.0054291578643,0,0,10.7887021680667,9.75383308992060,8.91329454256563,9.81462453977224];
    breathREF = A(i,j);
end  
% -------------------------------------------------------------------------